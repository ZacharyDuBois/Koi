#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
# Night Updater
# https://bitbucket.org/Zachary_DuBois/night-uploader
# (c) Copyright Zachary DuBois, 2014. All rights reserved.
version="v0.3"


##
# Variables
##

location=""
s3bucket=""
endLocation=""
templateLocation=""
# If you don't want to use Pushover, leave pushoverAppKey set to "".
pushoverAppKey=""
pushoverUserKey=""
pushoverTitle="Night Uploader"
pushoverURL=""
pushoverURLTitle=""


##
# Startup Checks
##

# Check for root
if [[ "$(id -u)" == "0" ]]
then
  echo "Do not run this script as root."
  exit 1
fi

# Check for AWS ClI
which aws > /dev/null
checkForAWS=$?
if [[ "$checkForAWS" != "0" ]]
then 
  echo "You need AWS CLI to run this script."
  exit 1
fi


##
# Start
##

pushoverSend() {
  message=$1
  if [[ "$pushoverAppKey" != "" ]] && [[ "$pushoverUserKey" != "" ]]
  then
    curl -s --form-string "token=$pushoverAppKey" --form-string "user=$pushoverUserKey" --form-string "url=$pushoverURL" --form-string "url_title=$pushoverURLTitle" --form-string "priority=0" --form-string "title=$pushoverTitle" --form-string "message=$message" https://api.pushover.net/1/messages.json > /dev/null
    pushoverStatus=$?
    if [[ "$pushoverStatus" == "0" ]]
    then
      echo "Pushover message sent successfully: $message"
    else
      echo "Pushover failed to send message: $message"
    fi
  else
    echo "No Pushover key set to send message: $message"
  fi
}

if [[ "$(ls $location)" == "" ]]
then
  # No Files
  echo "No files for upload, exiting."
  pushoverSend "No uploads tonight! Enjoy!"
else
  # Files
  echo "Files found, uploading $location ==> s3://"$s3bucket"/"
  pushoverSend "Starting to upload files to s3://"$s3bucket"/. Internet may slow down a bit."
  
  # Make a new files list
  echo "Generating new files list."
  curTime=$(date '+%F %T')
  newUploadsFile="$location""New-Uploads.txt"
  ls $location > $newUploadsFile
  echo "Last Updated: $curTime" >> $newUploadsFile
  
  # Upload
  echo "Starting upload to s3://"$s3bucket"/"
  aws s3 cp $location s3://"$s3bucket"/ --recursive --exclude ".*"
  
  # Generate Index
  echo "Generating index file."
  indexFile="$location""index.html"
  listingFile="$location""tmp"
  numberOfFiles=0
  aws s3 ls s3://"$s3bucket"/ | grep -v PRE | awk -F' ' '{ print $4 }' > $listingFile
  cat "$templateLocation""head" > $indexFile
  while read listItem
  do
    $((numberOfFiles++))
    echo "    <li><a href=\"/"$listItem"\">"$listItem"</a></li>" >> $indexFile
  done < $listingFile
  cat "$templateLocation""afterlist" >> $indexFile
  echo "  <p><code>"$numberOfFiles" Items</code></p>" >> $indexFile
  echo "  <p>Index Last Updated: <code>"$curTime"</code></p>" >> $indexFile
  echo "  <p>Files uploaded and generated with <a href=https\:\/\/bitbucket.org\/Zachary_DuBois\/night-uploader\">Night Uploader</a> <code>"$version"</code></p>" >> $indexFile
  cat "$templateLocation""footer" >> $indexFile
  rm $listingFile
  
  
  # Delete the new uploads file
  echo "Removing new files list."
  rm $newUploadsFile
  
  # Move them to the done location.
  echo "Moving files to $endLocation..."
  mv "$location"* $endLocation
  pushoverSend "All done! Enjoy your uploads!"
fi


##
# Done
##

echo "Done"

exit 0
